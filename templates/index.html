<!-- file: templates/index.html -->
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart E-Banking System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none !important; }
        /* Animations */
        @keyframes slideInRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        /* Glassmorphism */
        .glass-dark { background: rgba(0, 0, 0, 0.2); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        /* Custom Components */
        .btn { @apply px-6 py-3 rounded-xl font-semibold transition-all duration-300 cursor-pointer shadow-md; }
        .btn-primary { @apply bg-gradient-to-r from-blue-600 to-indigo-600 text-white hover:shadow-lg hover:from-blue-700 hover:to-indigo-700 transform hover:-translate-y-1; }
        .form-input { @apply w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-300; }
        .sidebar-item { @apply flex items-center px-4 py-3 mx-2 my-1 rounded-xl cursor-pointer transition-all duration-300 hover:bg-indigo-600 hover:text-white; }
        .admin-sidebar-item { @apply flex items-center px-4 py-3 mx-2 my-1 rounded-xl cursor-pointer transition-all duration-300 hover:bg-red-600 hover:text-white; }
        .sidebar-item.active { background-color: #4f46e5; color: white; font-weight: 600; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.4); }
        .admin-sidebar-item.active { background-color: #dc2626; color: white; font-weight: 600; box-shadow: 0 4px 10px rgba(220, 38, 38, 0.4); }
        .spinner { @apply animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600; }
        .hero-gradient { background: linear-gradient(135deg, #3f51b5 0%, #764ba2 100%); }
        .chat-bubble { @apply max-w-xs p-3 rounded-2xl mb-2 animate-fade-in-up shadow; }
        .chat-user { @apply bg-indigo-500 text-white ml-auto rounded-br-none; }
        .chat-bot { @apply bg-gray-200 text-gray-800 rounded-bl-none; }
        .card { @apply bg-white rounded-2xl shadow-lg p-6 transition-all duration-300 hover:shadow-2xl hover:transform hover:-translate-y-1; }
    </style>
</head>
<body class="h-full bg-gray-100">
    <div id="app" class="h-full">
        <!-- Homepage View -->
        <div id="homepage-view" class="min-h-full">
            <nav class="glass-dark fixed w-full top-0 z-50">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <div class="flex items-center"><i class="fas fa-university text-2xl text-indigo-300"></i><span class="ml-3 text-xl font-bold text-white">SmartBank</span></div>
                        <div class="flex space-x-4">
                            <button onclick="showModal('user-login-modal')" class="btn btn-primary">User Login</button>
                            <button onclick="showModal('user-register-modal')" class="btn bg-gray-100 text-indigo-700 hover:bg-gray-200">Register</button>
                            <button onclick="showModal('admin-login-modal')" class="btn bg-gray-700 text-white hover:bg-gray-800">Admin</button>
                        </div>
                    </div>
                </div>
            </nav>
            <div class="hero-gradient min-h-screen flex items-center justify-center">
                <div class="text-center text-white px-4">
                    <h1 class="text-5xl md:text-6xl font-extrabold mb-4 animate-fade-in-up">The Future of Banking is Here</h1>
                    <p class="text-xl md:text-2xl text-indigo-100 mb-8 max-w-3xl mx-auto animate-fade-in-up" style="animation-delay: 0.2s;">Secure, intelligent, and seamless banking powered by cutting-edge AI technology.</p>
                </div>
            </div>
        </div>

        <!-- All Modals -->
        <div id="user-login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"><div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 animate-fade-in-up"><h2 class="text-3xl font-bold text-gray-800 text-center mb-6">User Login</h2><form id="user-login-form" class="space-y-6"><input type="text" id="user-username" class="form-input" placeholder="Username" required><input type="password" id="user-password" class="form-input" placeholder="Password" required><div class="flex items-center"><input type="checkbox" id="enable-2fa" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="enable-2fa" class="ml-2 block text-sm text-gray-900">Use Two-Factor Authentication</label></div><button type="submit" class="btn btn-primary w-full text-lg"><i class="fas fa-sign-in-alt mr-2"></i>Sign In</button></form><p id="user-login-message" class="mt-4 text-center text-sm text-red-600"></p><div class="mt-6 text-center"><button onclick="closeModals()" class="text-gray-500 hover:text-gray-700">Close</button></div></div></div>
        <div id="admin-login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"><div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 animate-fade-in-up"><h2 class="text-3xl font-bold text-gray-800 text-center mb-6">Admin Login</h2><form id="admin-login-form" class="space-y-6"><input type="text" id="admin-username" class="form-input" placeholder="Admin Username" required value="admin"><input type="password" id="admin-password" class="form-input" placeholder="Admin Password" required value="admin123"><button type="submit" class="btn bg-red-600 text-white hover:bg-red-700 w-full text-lg"><i class="fas fa-key mr-2"></i>Admin Access</button></form><p id="admin-login-message" class="mt-4 text-center text-sm text-red-600"></p><div class="mt-6 text-center"><button onclick="closeModals()" class="text-gray-500 hover:text-gray-700">Close</button></div></div></div>
        <div id="user-register-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"><div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 animate-fade-in-up"><h2 class="text-3xl font-bold text-gray-800 text-center mb-6">Create Account</h2><form id="register-form" class="space-y-4"><input type="text" id="register-username" class="form-input" placeholder="Username" required><input type="email" id="register-email" class="form-input" placeholder="Email Address" required><input type="password" id="register-password" class="form-input" placeholder="Password" required><button type="submit" class="btn btn-primary w-full text-lg"><i class="fas fa-user-plus mr-2"></i>Register</button></form><p id="register-message" class="mt-4 text-center text-sm"></p><div class="mt-6 text-center"><button onclick="closeModals()" class="text-gray-500 hover:text-gray-700">Close</button></div></div></div>
        <div id="edit-transaction-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"><div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 animate-fade-in-up"><h2 class="text-3xl font-bold text-gray-800 text-center mb-6">Edit Transaction</h2><form id="edit-transaction-form" class="space-y-4"><input type="hidden" id="edit-tx-id"><input type="text" id="edit-tx-description" class="form-input" placeholder="Description" required><input type="text" id="edit-tx-type" class="form-input" placeholder="Type (e.g., Transfer, Groceries)" required><button type="submit" class="btn btn-primary w-full text-lg">Save Changes</button></form><div class="mt-6 text-center"><button onclick="closeModals()" class="text-gray-500 hover:text-gray-700">Cancel</button></div></div></div>
        <div id="tfa-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"><div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 animate-fade-in-up"><h2 class="text-2xl font-bold text-gray-800 text-center mb-2">2FA Verification</h2><p class="text-center text-gray-600 mb-6">Enter code: 123456</p><div class="flex justify-center space-x-2 mb-6"><input type="text" maxlength="6" id="tfa-code" class="form-input text-center tracking-[1em]"></div><button onclick="verify2FA()" class="btn btn-primary w-full">Verify</button></div></div>
        <div id="admin-create-user-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"><div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 animate-fade-in-up"><h2 class="text-3xl font-bold text-gray-800 text-center mb-6">Create New User</h2><form id="admin-create-user-form" class="space-y-4"><input type="text" id="create-username" class="form-input" placeholder="Username" required><input type="email" id="create-email" class="form-input" placeholder="Email Address" required><input type="password" id="create-password" class="form-input" placeholder="Initial Password" required><button type="submit" class="btn btn-primary w-full text-lg">Create User Account</button></form><p id="admin-create-user-message" class="mt-4 text-center text-sm"></p><div class="mt-6 text-center"><button onclick="closeModals()" class="text-gray-500 hover:text-gray-700">Close</button></div></div></div>

        <!-- User Dashboard -->
        <div id="user-dashboard" class="h-full hidden"><div class="flex h-full"><nav class="w-64 bg-gray-900 text-gray-300 flex flex-col"><div class="p-6 text-2xl font-bold text-white border-b border-gray-700 flex items-center"><i class="fas fa-university mr-3 text-indigo-400"></i>SmartBank</div><ul class="flex-grow p-4" id="user-sidebar-nav"><li><a href="#" class="sidebar-item active" data-view="user-dashboard-content"><i class="fas fa-tachometer-alt w-6 text-center mr-3"></i>Dashboard</a></li><li><a href="#" class="sidebar-item" data-view="user-transactions-content"><i class="fas fa-exchange-alt w-6 text-center mr-3"></i>Transactions</a></li><li><a href="#" class="sidebar-item" data-view="user-billpay-content"><i class="fas fa-file-invoice-dollar w-6 text-center mr-3"></i>Bill Pay</a></li></ul><div class="p-4 border-t border-gray-700"><button onclick="logout()" class="w-full btn bg-red-600 text-white hover:bg-red-700"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button></div></nav><main class="flex-1 bg-gray-100 overflow-y-auto p-8" id="user-main-content"></main></div></div>
        
        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="h-full hidden"><div class="flex h-full"><nav class="w-64 bg-gray-900 text-gray-300 flex flex-col"><div class="p-6 text-2xl font-bold text-white border-b border-gray-700 flex items-center"><i class="fas fa-shield-alt mr-3 text-red-400"></i>Admin Panel</div><ul class="flex-grow p-4" id="admin-sidebar-nav"><li><a href="#" class="admin-sidebar-item active" data-view="admin-dashboard-content"><i class="fas fa-tachometer-alt w-6 text-center mr-3"></i>Overview</a></li><li><a href="#" class="admin-sidebar-item" data-view="admin-users-content"><i class="fas fa-users w-6 text-center mr-3"></i>Users</a></li><li><a href="#" class="admin-sidebar-item" data-view="admin-transactions-content"><i class="fas fa-exchange-alt w-6 text-center mr-3"></i>Transactions</a></li><li><a href="#" class="admin-sidebar-item" data-view="admin-reports-content"><i class="fas fa-chart-line w-6 text-center mr-3"></i>Reports</a></li></ul><div class="p-4 border-t border-gray-700"><button onclick="logout()" class="w-full btn bg-gray-600 text-white hover:bg-gray-700"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button></div></nav><main class="flex-1 bg-gray-100 overflow-y-auto p-8" id="admin-main-content"></main></div></div>

        <!-- AI Chatbot -->
        <div id="chatbot-container" class="fixed bottom-6 right-6 z-40 hidden"><button id="chatbot-toggle" class="w-16 h-16 bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700 transition-all duration-300 flex items-center justify-center transform hover:scale-110"><i class="fas fa-robot text-2xl"></i></button><div id="chatbot-window" class="hidden absolute bottom-20 right-0 w-80 h-96 bg-white rounded-2xl shadow-2xl flex flex-col"><div class="bg-indigo-600 text-white p-4 rounded-t-2xl flex items-center justify-between"><span class="font-semibold">SmartBot AI Assistant</span><button id="chatbot-close" class="text-white hover:text-indigo-100"><i class="fas fa-times"></i></button></div><div id="chat-messages" class="p-4 flex-grow overflow-y-auto bg-gray-50"></div><div class="p-4 border-t bg-white"><div class="flex space-x-2"><input type="text" id="chat-input" class="flex-1 form-input" placeholder="Ask me anything..."><button id="send-message" class="btn btn-primary px-4 py-2"><i class="fas fa-paper-plane"></i></button></div></div></div></div>

        <!-- Loading Overlay & Templates -->
        <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"><div class="spinner"></div></div>
        <template id="user-dashboard-template"><h1 class="text-4xl font-bold text-gray-800 mb-2">Welcome back, <span id="dashboard-username"></span>!</h1><div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8"><div class="lg:col-span-2 space-y-6"><div class="card"><h3 class="text-lg font-semibold text-gray-600 mb-1">Total Balance</h3><p id="account-balance" class="text-4xl font-bold text-gray-800">$0.00</p><p class="text-gray-500 mt-2">Account: <span id="account-number" class="font-medium"></span></p></div><div class="card"><h3 class="text-lg font-semibold text-gray-600 mb-4">Quick Transfer</h3><form id="transaction-form" class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end"><input type="text" id="to-account" class="form-input sm:col-span-1" placeholder="Recipient Account #" required><input type="number" id="amount" class="form-input" placeholder="Amount" step="0.01" min="0.01" required><button type="submit" class="btn btn-primary h-12">Send Money</button></form><p id="transaction-message" class="text-sm mt-4"></p></div></div><div class="card"><h3 class="text-lg font-semibold text-gray-600 mb-4">Spending Insights</h3><canvas id="spending-chart"></canvas><p id="spending-chart-fallback" class="text-center text-gray-500 hidden">No spending data available.</p></div></div></template>
        <template id="user-transactions-template"><h1 class="text-3xl font-bold text-gray-800 mb-8">Transaction History</h1><div class="card overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left">Details</th><th class="px-6 py-3 text-left">Type</th><th class="px-6 py-3 text-left">Amount</th><th class="px-6 py-3 text-left">Date</th></tr></thead><tbody id="transaction-history" class="divide-y"></tbody></table></div></template>
        <template id="user-billpay-template"><h1 class="text-3xl font-bold text-gray-800 mb-8">Bill Payment</h1><div class="max-w-md mx-auto card"><form id="billpay-form" class="space-y-4"><select id="biller-select" class="form-input" required></select><input type="number" id="bill-amount" class="form-input" placeholder="Amount" step="0.01" min="0.01" required><button type="submit" class="w-full btn btn-primary">Pay Now</button></form><p id="billpay-message" class="text-sm mt-4 text-center"></p></div></template>
        <template id="admin-dashboard-template"><h1 class="text-4xl font-bold text-gray-800 mb-8">Admin Dashboard</h1><div class="grid grid-cols-1 md:grid-cols-4 gap-6"><div class="card"><p class="text-gray-600">Total Users</p><p id="total-users" class="text-3xl font-bold">0</p></div><div class="card"><p class="text-gray-600">Total Accounts</p><p id="total-accounts" class="text-3xl font-bold">0</p></div><div class="card"><p class="text-gray-600">Transactions Today</p><p id="transactions-today" class="text-3xl font-bold">0</p></div><div class="card"><p class="text-gray-600">Security Alerts</p><p id="security-alerts" class="text-3xl font-bold text-red-500">0</p></div></div></template>
        <template id="admin-users-template"><div class="flex justify-between items-center mb-8"><h1 class="text-3xl font-bold text-gray-800">User Management</h1><button onclick="showModal('admin-create-user-modal')" class="btn btn-primary"><i class="fas fa-plus mr-2"></i>Create User</button></div><div class="card overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left">User</th><th class="px-6 py-3 text-left">Status</th><th class="px-6 py-3 text-left">Created By</th><th class="px-6 py-3 text-left">Member Since</th><th class="px-6 py-3 text-left">Actions</th></tr></thead><tbody id="users-table-body" class="divide-y"></tbody></table></div></template>
        <template id="admin-transactions-template"><h1 class="text-3xl font-bold text-gray-800 mb-8">All Transactions</h1><div class="card overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left">Details</th><th class="px-6 py-3 text-left">Amount</th><th class="px-6 py-3 text-left">Date</th><th class="px-6 py-3 text-left">Actions</th></tr></thead><tbody id="admin-transactions-body" class="divide-y"></tbody></table></div></template>
        <template id="admin-reports-template"><h1 class="text-3xl font-bold text-gray-800 mb-8">Reports</h1><div class="max-w-md card"><h3 class="text-lg font-semibold text-gray-600 mb-4">Download Reports</h3><p class="text-gray-500 mb-6">Generate and download a full report of all system transactions in CSV format.</p><button id="download-report-btn" class="btn btn-primary w-full"><i class="fas fa-download mr-2"></i>Download Transaction Report</button></div></template>
    
    <script>
        // --- State, DOM Elements, and Templates ---
        const state = { token: localStorage.getItem('token'), username: localStorage.getItem('username'), isAdmin: localStorage.getItem('isAdmin') === 'true', account: null, spendingChart: null };
        const views = { homepage: document.getElementById('homepage-view'), userDashboard: document.getElementById('user-dashboard'), adminDashboard: document.getElementById('admin-dashboard') };
        const modals = document.querySelectorAll('.fixed.inset-0');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        // --- Core App Logic ---
        async function apiRequest(endpoint, method = 'GET', body = null) {
            loadingOverlay.classList.remove('hidden');
            const headers = { 'Content-Type': 'application/json' };
            if (state.token) headers['x-access-token'] = state.token;
            try {
                const response = await fetch(`/api${endpoint}`, { method, headers, body: body ? JSON.stringify(body) : null });
                if (response.status === 401) { logout(); return { ok: false, data: { message: 'Session expired' } }; }
                const data = await response.json();
                return { ok: response.ok, data };
            } catch (error) { return { ok: false, data: { message: 'Network error.' } };
            } finally { loadingOverlay.classList.add('hidden'); }
        }
        function showView(viewId) { Object.values(views).forEach(v => v.classList.add('hidden')); if(views[viewId]) views[viewId].classList.remove('hidden'); }
        function logout() { localStorage.clear(); Object.assign(state, { token: null, username: null, isAdmin: false }); showView('homepage'); document.getElementById('chatbot-container').classList.add('hidden'); }
        
        // --- Modal & Navigation ---
        function showModal(modalId) { document.getElementById(modalId)?.classList.remove('hidden'); }
        function closeModals() { modals.forEach(m => m.classList.add('hidden')); }
        function setupNavigation(containerId, mainContentId, isAdminNav) {
            document.getElementById(containerId)?.addEventListener('click', e => {
                const item = e.target.closest(isAdminNav ? '.admin-sidebar-item' : '.sidebar-item');
                if (item) {
                    e.preventDefault();
                    document.querySelectorAll(`#${containerId} > li > a`).forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    loadViewContent(item.dataset.view, mainContentId);
                }
            });
        }
        function loadViewContent(viewId, mainContentId) {
            const template = document.getElementById(`${viewId.replace('-content', '')}-template`);
            const container = document.getElementById(mainContentId);
            if (template && container) {
                container.innerHTML = template.innerHTML;
                container.firstElementChild?.classList.add('animate-fade-in-up');
                const actions = {
                    'user-dashboard-content': initUserDashboardContent, 'user-transactions-content': fetchTransactions,
                    'user-billpay-content': fetchBillers, 'admin-dashboard-content': fetchAdminStats,
                    'admin-users-content': fetchAllUsers, 'admin-transactions-content': fetchAdminTransactions,
                    'admin-reports-content': () => document.getElementById('download-report-btn').addEventListener('click', downloadReport)
                };
                actions[viewId]?.();
            }
        }

        // --- Auth & 2FA ---
        document.getElementById('user-login-form').addEventListener('submit', e => { e.preventDefault(); handleLogin(false, e.currentTarget); });
        document.getElementById('admin-login-form').addEventListener('submit', e => { e.preventDefault(); handleLogin(true, e.currentTarget); });
        function verify2FA() { if (document.getElementById('tfa-code').value === '123456') { loginSuccess(false); } else { alert('Invalid 2FA code.'); } }
        async function handleLogin(isAdmin, form) {
            const use2FA = !isAdmin && form.elements['enable-2fa'].checked;
            if (use2FA) { showModal('tfa-modal'); return; }
            loginSuccess(isAdmin, form);
        }
        async function loginSuccess(isAdmin, form) {
            const endpoint = isAdmin ? '/admin/login' : '/login';
            const username = form.elements[0].value;
            const password = form.elements[1].value;
            const res = await apiRequest(endpoint, 'POST', { username, password });
            if (res.ok) {
                Object.assign(state, { token: res.data.token, username: res.data.username, isAdmin });
                localStorage.setItem('token', state.token); localStorage.setItem('username', state.username); localStorage.setItem('isAdmin', String(state.isAdmin));
                closeModals();
                if(isAdmin) initAdminDashboard(); else initUserDashboard();
            } else { document.getElementById(`${isAdmin ? 'admin' : 'user'}-login-message`).textContent = res.data.message; }
        }
        
        // --- User Creation ---
        document.getElementById('register-form').addEventListener('submit', async e => {
            e.preventDefault();
            const res = await apiRequest('/register', 'POST', { username: e.target.elements['register-username'].value, email: e.target.elements['register-email'].value, password: e.target.elements['register-password'].value });
            const msgEl = document.getElementById('register-message');
            msgEl.textContent = res.data.message; msgEl.style.color = res.ok ? 'green' : 'red';
            if (res.ok) { setTimeout(() => { closeModals(); showModal('user-login-modal'); }, 1500); }
        });
        document.getElementById('admin-create-user-form')?.addEventListener('submit', async e => {
            e.preventDefault();
            const res = await apiRequest('/admin/users', 'POST', { username: e.target.elements['create-username'].value, email: e.target.elements['create-email'].value, password: e.target.elements['create-password'].value });
            const msgEl = document.getElementById('admin-create-user-message');
            msgEl.textContent = res.data.message; msgEl.style.color = res.ok ? 'green' : 'red';
            if (res.ok) { e.target.reset(); setTimeout(closeModals, 1500); fetchAllUsers(); }
        });

        // --- User Dashboard ---
        function initUserDashboard() { showView('userDashboard'); document.getElementById('chatbot-container').classList.remove('hidden'); loadViewContent('user-dashboard-content', 'user-main-content');}
        function initUserDashboardContent() { document.getElementById('dashboard-username').textContent = state.username; fetchDashboardData(); document.getElementById('transaction-form').addEventListener('submit', handleTransfer); }
        async function fetchDashboardData() { const accountRes = await apiRequest('/account'); if (accountRes.ok && accountRes.data.account) { state.account = accountRes.data.account; document.getElementById('account-number').textContent = state.account.account_number; document.getElementById('account-balance').textContent = `$${parseFloat(state.account.balance).toFixed(2)}`; } const insightsRes = await apiRequest('/insights'); if (insightsRes.ok) renderSpendingChart(insightsRes.data); }
        async function fetchTransactions() { const res = await apiRequest('/transactions'); const tbody = document.getElementById('transaction-history'); if(!tbody) return; tbody.innerHTML = res.ok && res.data.transactions.length ? res.data.transactions.map(tx => { const isDebit = tx.from_account === state.account.account_number; return `<tr><td class="p-4">${tx.description}<br><small class="text-gray-500">${isDebit ? 'To: ' + tx.to_account : 'From: ' + tx.from_account}</small></td><td class="p-4">${tx.type}</td><td class="p-4 font-semibold ${isDebit ? 'text-red-600' : 'text-green-600'}">${isDebit ? '-' : '+'} $${tx.amount.toFixed(2)}</td><td class="p-4">${new Date(tx.timestamp).toLocaleString()}</td></tr>`; }).join('') : '<tr><td colspan="4" class="p-4 text-center">No transactions yet.</td></tr>'; }
        async function fetchBillers() { const res = await apiRequest('/billers'); const select = document.getElementById('biller-select'); if (res.ok && select) { select.innerHTML = '<option value="" disabled selected>Choose a biller...</option>' + res.data.billers.map(b => `<option value="${b._id}">${b.name}</option>`).join(''); document.getElementById('billpay-form').addEventListener('submit', handleBillPay); } }
        function renderSpendingChart({labels, data}) { const canvas = document.getElementById('spending-chart'); if(!canvas) return; const fallback = document.getElementById('spending-chart-fallback'); if (state.spendingChart) state.spendingChart.destroy(); if (!labels || labels.length === 0) { fallback.classList.remove('hidden'); canvas.classList.add('hidden'); return; } fallback.classList.add('hidden'); canvas.classList.remove('hidden'); state.spendingChart = new Chart(canvas.getContext('2d'), { type: 'doughnut', data: { labels, datasets: [{ data, backgroundColor: ['#4f46e5', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6'] }] }, options: { responsive: true, plugins: { legend: { position: 'top' }}} }); }
        async function handleTransfer(e) { e.preventDefault(); const res = await apiRequest('/transactions', 'POST', { to_account_number: e.target.elements['to-account'].value, amount: e.target.elements['amount'].value }); const msgEl = document.getElementById('transaction-message'); if(msgEl){ msgEl.textContent = res.data.message; msgEl.style.color = res.ok ? 'green' : 'red'; } if (res.ok) { e.target.reset(); fetchDashboardData(); } }
        async function handleBillPay(e) { e.preventDefault(); const res = await apiRequest('/bill-payment', 'POST', { biller_id: e.target.elements['biller-select'].value, amount: e.target.elements['bill-amount'].value }); const msgEl = document.getElementById('billpay-message'); if(msgEl){ msgEl.textContent = res.data.message; msgEl.style.color = res.ok ? 'green' : 'red'; } if (res.ok) { e.target.reset(); fetchDashboardData(); } }

        // --- Admin Dashboard ---
        function initAdminDashboard() { showView('adminDashboard'); loadViewContent('admin-dashboard-content', 'admin-main-content');}
        async function fetchAdminStats() { const res = await apiRequest('/admin/stats'); if (res.ok) Object.keys(res.data).forEach(k => { const el = document.getElementById(k.replace(/([A-Z])/g, "-$1").toLowerCase()); if(el) el.textContent = res.data[k] }); }
        async function fetchAllUsers() { const res = await apiRequest('/admin/users'); const tbody = document.getElementById('users-table-body'); if(res.ok && tbody) tbody.innerHTML = res.data.users.map(user => `<tr><td class="p-4">${user.username}<br><small class="text-gray-500">${user.email}</small></td><td class="p-4"><span class="px-2 py-1 rounded-full text-xs ${user.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">${user.status}</span></td><td class="p-4">${user.created_by_admin ? 'Admin' : 'Self'}</td><td class="p-4">${new Date(user.created_at).toLocaleDateString()}</td><td class="p-4"><button class="text-sm p-1 text-indigo-600 hover:underline" onclick="updateUserStatus('${user._id}', '${user.status === 'active' ? 'suspended' : 'active'}')">${user.status === 'active' ? 'Suspend' : 'Activate'}</button><button class="text-sm p-1 text-red-600 hover:underline" onclick="deleteUser('${user._id}')">Delete</button></td></tr>`).join(''); }
        async function updateUserStatus(userId, newStatus) { if (confirm(`Are you sure you want to ${newStatus} this user?`)) { await apiRequest(`/admin/users/${userId}`, 'PUT', { status: newStatus }); fetchAllUsers(); }}
        async function deleteUser(userId) { if (confirm('Delete this user permanently? This cannot be undone.')) { await apiRequest(`/admin/users/${userId}`, 'DELETE'); fetchAllUsers(); }}
        async function fetchAdminTransactions() { const res = await apiRequest('/admin/transactions'); const tbody = document.getElementById('admin-transactions-body'); if(res.ok && tbody) tbody.innerHTML = res.data.transactions.map(tx => `<tr><td class="p-4">${tx.description}<br><small class="text-gray-500">From: ${tx.from_account} To: ${tx.to_account}</small></td><td class="p-4 font-semibold">$${tx.amount.toFixed(2)}</td><td class="p-4">${new Date(tx.timestamp).toLocaleString()}</td><td class="p-4"><button class="text-sm p-1 text-indigo-600 hover:underline" onclick="showEditTransaction('${tx._id}', '${tx.description}', '${tx.type}')">Edit</button><button class="text-sm p-1 text-red-600 hover:underline" onclick="deleteTransaction('${tx._id}')">Delete</button></td></tr>`).join(''); }
        function showEditTransaction(id, desc, type) { document.getElementById('edit-tx-id').value = id; document.getElementById('edit-tx-description').value = desc; document.getElementById('edit-tx-type').value = type; showModal('edit-transaction-modal'); }
        document.getElementById('edit-transaction-form').addEventListener('submit', async e => { e.preventDefault(); const id = e.target.elements['edit-tx-id'].value; await apiRequest(`/admin/transactions/${id}`, 'PUT', { description: e.target.elements['edit-tx-description'].value, type: e.target.elements['edit-tx-type'].value }); closeModals(); fetchAdminTransactions(); });
        async function deleteTransaction(txId) { if (confirm('Delete this transaction? This cannot be undone.')) { await apiRequest(`/admin/transactions/${txId}`, 'DELETE'); fetchAdminTransactions(); }}
        async function downloadReport() { loadingOverlay.classList.remove('hidden'); fetch('/api/admin/reports/transactions.csv', { headers: { 'x-access-token': state.token } }).then(resp => resp.blob()).then(blob => { const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = 'transaction_report.csv'; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); }).catch(() => alert('Could not download report.')).finally(() => loadingOverlay.classList.add('hidden')); }
        
        // --- Chatbot ---
        const chatbotToggle = document.getElementById('chatbot-toggle'); const chatbotWindow = document.getElementById('chatbot-window');
        chatbotToggle.addEventListener('click', () => chatbotWindow.classList.toggle('hidden'));
        document.getElementById('chatbot-close').addEventListener('click', () => chatbotWindow.classList.add('hidden'));
        const chatInput = document.getElementById('chat-input');
        const sendMessageBtn = document.getElementById('send-message');
        const chatMessages = document.getElementById('chat-messages');
        const sendMessage = async () => {
            const message = chatInput.value.trim();
            if (!message) return;
            addChatMessage(message, 'user'); chatInput.value = '';
            const res = await apiRequest('/chatbot', 'POST', { message });
            if(res.ok) { addChatMessage(res.data.reply, 'bot'); } else { addChatMessage("Sorry, I'm having trouble connecting right now.", 'bot'); }
        };
        sendMessageBtn.addEventListener('click', sendMessage); chatInput.addEventListener('keypress', e => e.key === 'Enter' && sendMessage());
        function addChatMessage(text, sender) { const div = document.createElement('div'); div.className = `chat-bubble chat-${sender}`; div.innerHTML = text.replace(/\n/g, '<br>'); chatMessages.appendChild(div); chatMessages.scrollTop = chatMessages.scrollHeight; }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            if (state.token) { state.isAdmin ? initAdminDashboard() : initUserDashboard(); } else { showView('homepage'); }
            setupNavigation('user-sidebar-nav', 'user-main-content', false);
            setupNavigation('admin-sidebar-nav', 'admin-main-content', true);
        });
    </script>
</body>
</html>

